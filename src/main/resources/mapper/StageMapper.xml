<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spark.insight.mapper.StageMapper">

    <!-- 预计算 Stage 的聚合指标 -->
    <update id="updateStageMetrics">
        UPDATE stages s
        SET 
            gc_time_sum = m.total_gc,
            input_bytes = m.total_input,
            shuffle_read_bytes = m.total_shuffle_read,
            duration_p50 = m.p50,
            duration_p95 = m.p95,
            duration_p99 = m.p99,
            is_skewed = (CASE WHEN m.max_dur > m.p50 * 2 THEN TRUE ELSE FALSE END)
        FROM (
            SELECT 
                app_id, 
                stage_id,
                sum(gc_time) as total_gc,
                sum(input_bytes) as total_input, -- 注意：Schema 中 task 暂无 input_bytes，后续需补充
                sum(shuffle_read_bytes) as total_shuffle_read,
                approx_quantile(duration, 0.5) as p50,
                approx_quantile(duration, 0.95) as p95,
                approx_quantile(duration, 0.99) as p99,
                max(duration) as max_dur
            FROM tasks
            WHERE app_id = #{appId}
            GROUP BY app_id, stage_id
        ) m
        WHERE s.app_id = m.app_id AND s.stage_id = m.stage_id
    </update>

    <delete id="deleteStageStats">
        DELETE FROM stage_statistics WHERE app_id = #{appId}
    </delete>

    <!-- 计算详细的 Task 分布统计并存入 stage_statistics 表 -->
    <insert id="insertTaskStats">
        INSERT INTO stage_statistics (id, app_id, stage_id, attempt_id, metric_name, min_value, p25, p50, p75, p95, max_value)
        WITH task_stats AS (
            SELECT 
                app_id, 
                stage_id,
                'duration' as metric_name,
                min(duration) as min_v,
                approx_quantile(duration, 0.25) as p25,
                approx_quantile(duration, 0.5) as p50,
                approx_quantile(duration, 0.75) as p75,
                approx_quantile(duration, 0.95) as p95,
                max(duration) as max_v
            FROM tasks WHERE app_id = #{appId} GROUP BY app_id, stage_id
            UNION ALL
            SELECT 
                app_id, stage_id, 'gc_time',
                min(gc_time), approx_quantile(gc_time, 0.25), approx_quantile(gc_time, 0.5), approx_quantile(gc_time, 0.75), approx_quantile(gc_time, 0.95), max(gc_time)
            FROM tasks WHERE app_id = #{appId} GROUP BY app_id, stage_id
            UNION ALL
            SELECT 
                app_id, stage_id, 'memory_spill',
                min(memory_bytes_spilled), approx_quantile(memory_bytes_spilled, 0.25), approx_quantile(memory_bytes_spilled, 0.5), approx_quantile(memory_bytes_spilled, 0.75), approx_quantile(memory_bytes_spilled, 0.95), max(memory_bytes_spilled)
            FROM tasks WHERE app_id = #{appId} GROUP BY app_id, stage_id
            UNION ALL
            SELECT 
                app_id, stage_id, 'disk_spill',
                min(disk_bytes_spilled), approx_quantile(disk_bytes_spilled, 0.25), approx_quantile(disk_bytes_spilled, 0.5), approx_quantile(disk_bytes_spilled, 0.75), approx_quantile(disk_bytes_spilled, 0.95), max(disk_bytes_spilled)
            FROM tasks WHERE app_id = #{appId} GROUP BY app_id, stage_id
            UNION ALL
            SELECT 
                app_id, stage_id, 'shuffle_read',
                min(shuffle_read_bytes), approx_quantile(shuffle_read_bytes, 0.25), approx_quantile(shuffle_read_bytes, 0.5), approx_quantile(shuffle_read_bytes, 0.75), approx_quantile(shuffle_read_bytes, 0.95), max(shuffle_read_bytes)
            FROM tasks WHERE app_id = #{appId} GROUP BY app_id, stage_id
            UNION ALL
            SELECT 
                app_id, stage_id, 'shuffle_read_records',
                min(shuffle_read_records), approx_quantile(shuffle_read_records, 0.25), approx_quantile(shuffle_read_records, 0.5), approx_quantile(shuffle_read_records, 0.75), approx_quantile(shuffle_read_records, 0.95), max(shuffle_read_records)
            FROM tasks WHERE app_id = #{appId} GROUP BY app_id, stage_id
            UNION ALL
            SELECT 
                app_id, stage_id, 'shuffle_write',
                min(shuffle_write_bytes), approx_quantile(shuffle_write_bytes, 0.25), approx_quantile(shuffle_write_bytes, 0.5), approx_quantile(shuffle_write_bytes, 0.75), approx_quantile(shuffle_write_bytes, 0.95), max(shuffle_write_bytes)
            FROM tasks WHERE app_id = #{appId} GROUP BY app_id, stage_id
            UNION ALL
            SELECT 
                app_id, stage_id, 'shuffle_write_records',
                min(shuffle_write_records), approx_quantile(shuffle_write_records, 0.25), approx_quantile(shuffle_write_records, 0.5), approx_quantile(shuffle_write_records, 0.75), approx_quantile(shuffle_write_records, 0.95), max(shuffle_write_records)
            FROM tasks WHERE app_id = #{appId} GROUP BY app_id, stage_id
            UNION ALL
            SELECT 
                app_id, stage_id, 'task_deserialization_time',
                min(executor_deserialize_time), approx_quantile(executor_deserialize_time, 0.25), approx_quantile(executor_deserialize_time, 0.5), approx_quantile(executor_deserialize_time, 0.75), approx_quantile(executor_deserialize_time, 0.95), max(executor_deserialize_time)
            FROM tasks WHERE app_id = #{appId} GROUP BY app_id, stage_id
            UNION ALL
            SELECT 
                app_id, stage_id, 'result_serialization_time',
                min(result_serialization_time), approx_quantile(result_serialization_time, 0.25), approx_quantile(result_serialization_time, 0.5), approx_quantile(result_serialization_time, 0.75), approx_quantile(result_serialization_time, 0.95), max(result_serialization_time)
            FROM tasks WHERE app_id = #{appId} GROUP BY app_id, stage_id
            UNION ALL
            SELECT 
                app_id, stage_id, 'getting_result_time',
                min(getting_result_time), approx_quantile(getting_result_time, 0.25), approx_quantile(getting_result_time, 0.5), approx_quantile(getting_result_time, 0.75), approx_quantile(getting_result_time, 0.95), max(getting_result_time)
            FROM tasks WHERE app_id = #{appId} GROUP BY app_id, stage_id
            UNION ALL
            SELECT 
                app_id, stage_id, 'scheduler_delay',
                min(scheduler_delay), approx_quantile(scheduler_delay, 0.25), approx_quantile(scheduler_delay, 0.5), approx_quantile(scheduler_delay, 0.75), approx_quantile(scheduler_delay, 0.95), max(scheduler_delay)
            FROM tasks WHERE app_id = #{appId} GROUP BY app_id, stage_id
            UNION ALL
            SELECT 
                app_id, stage_id, 'peak_execution_memory',
                min(peak_execution_memory), approx_quantile(peak_execution_memory, 0.25), approx_quantile(peak_execution_memory, 0.5), approx_quantile(peak_execution_memory, 0.75), approx_quantile(peak_execution_memory, 0.95), max(peak_execution_memory)
            FROM tasks WHERE app_id = #{appId} GROUP BY app_id, stage_id
            UNION ALL
            SELECT 
                app_id, stage_id, 'input_bytes',
                min(input_bytes), approx_quantile(input_bytes, 0.25), approx_quantile(input_bytes, 0.5), approx_quantile(input_bytes, 0.75), approx_quantile(input_bytes, 0.95), max(input_bytes)
            FROM tasks WHERE app_id = #{appId} GROUP BY app_id, stage_id
            UNION ALL
            SELECT 
                app_id, stage_id, 'input_records',
                min(input_records), approx_quantile(input_records, 0.25), approx_quantile(input_records, 0.5), approx_quantile(input_records, 0.75), approx_quantile(input_records, 0.95), max(input_records)
            FROM tasks WHERE app_id = #{appId} GROUP BY app_id, stage_id
            UNION ALL
            SELECT 
                app_id, stage_id, 'shuffle_write_time',
                min(shuffle_write_time), approx_quantile(shuffle_write_time, 0.25), approx_quantile(shuffle_write_time, 0.5), approx_quantile(shuffle_write_time, 0.75), approx_quantile(shuffle_write_time, 0.95), max(shuffle_write_time)
            FROM tasks WHERE app_id = #{appId} GROUP BY app_id, stage_id
        )
        SELECT 
            app_id || ':' || stage_id || ':0:' || metric_name,
            app_id, stage_id, 0, metric_name, min_v, p25, p50, p75, p95, max_v
        FROM task_stats
    </insert>

</mapper>
